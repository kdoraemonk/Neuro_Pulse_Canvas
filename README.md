# Neuro_Pulse_Canvas: 神经事件可视化仪表盘

![仪表盘操作演示](./脑波数据可视化操作和界面演示.gif)

## 1. 项目介绍

### 1.1. 项目理念与目的

在神经科学研究中，我们面对的是海量、高维度的电生理数据，如局部场电位 (LFP) 和神经元脉冲 (Spike)。传统的静态图表或时序波形图虽然精确，但在揭示大规模神经元集群的**时空动态模式**方面存在局限。

本项目的核心目的，是借鉴**事件相机 (Event Camera)** 的工作原理，开发一套全新的、动态的、交互式的可视化方案。

### 1.2. 与事件相机的类比关系

传统的相机以固定的帧率捕捉画面，无论画面内容是否变化，都会记录完整的图像。这对应了传统的神经科学可视化，例如，无论神经元是否放电，我们都会绘制出整段时间的背景。

**事件相机**则完全不同，它是一种仿生传感器，其工作方式更接近生物的视觉系统。它不记录完整的图像帧，而只在场景中**有变化发生时**（例如，物体的边缘移动导致了像素亮度的改变），才异步地、以微秒级的时间精度记录下“事件”信息（像素位置、时间和亮度变化方向）。

本项目将这一理念应用于神经电生理数据：

-   **LFP 可视化**: 我们不直接展示原始的、充满噪声的电压波动，而是将其转换为特定脑波频段（如 Gamma 波）的**能量变化**。只有当能量强度超过某个阈值或发生显著变化时，我们才在对应的“像素”（电极通道）上展示一个强烈的视觉信号。这就像事件相机只捕捉光线变化最剧烈的地方一样。

-   **Spike 可视化**: 神经元的脉冲放电（Spike）本身就是一种“事件”。我们的可视化方案摒弃了在时间轴上画静态刻度线的传统光栅图（Raster Plot），而是将每一次脉冲放电视为一个在空间中（神经元物理位置）爆发的“光点”，并让其亮度随时间自然衰减。这使得观察者能直观地“看到”神经活动的发生、传播和消散，如同观察夜空中的闪烁星光。

通过这种方式，我们将观察者从繁杂的背景信号中解放出来，使其能更专注于神经活动本身，从而更容易发现数据中隐藏的传播模式、节律性爆发和脑区之间的同步性。

更详细的技术类比，包括微电极阵列（MEA）、传统相机与事件相机在空间单元、分辨率、时间采样、信噪比等多个维度上的深入对比，请参阅文档：[《阵列传感器间的类比》](./阵列传感器间的类比.pdf)。

### 1.3. 数据来源：Allen Brain Observatory

本项目使用的数据来自 **艾伦脑科学研究所 (Allen Institute for Brain Science)** 的公开数据集，通过其提供的 `AllenSDK` 进行访问。`AllenSDK` 是一个强大的 Python 工具包，它使得研究人员能够以编程方式访问和处理艾伦脑科学研究所发布的各种大规模、标准化的神经科学数据集。

在本项目中，我们具体使用了 **Allen Brain Observatory - Ecephys (Electrophysiology)** 数据集中的以下部分：
- **实验会话 (Session)**: 我们选取了 `session_id = 847657808` 的实验数据。
- **探针数据 (Probe Data)**: 该会话中，我们关注由 Neuropixels 探针记录的数据，特别是 `probe_id = 848037574` 等探针采集的信号。
- **数据类型**:
    - **局部场电位 (LFP)**: 用于分析特定脑区的电位波动和脑波节律（如 Gamma 波）。
    - **神经元脉冲 (Spikes)**: 用于分析单个神经元的放电时间和空间位置。
    - **通道与单位元信息 (Channels and Units)**: 用于获取电极的物理位置、对应的脑区结构，以及每个已分类神经元（unit）的元数据。

通过 `AllenSDK`，我们能够下载标准化的 NWB (Neurodata Without Borders) 格式的缓存文件，这些文件构成了本可视化项目分析的基础。

**引用链接**:
- **AllenSDK 文档**: [https://allensdk.readthedocs.io/](https://allensdk.readthedocs.io/)
- **Allen Brain Observatory**: [https://observatory.brain-map.org/](https://observatory.brain-map.org/)

---

## 2. 仪表盘视图详解

本仪表盘分为两个主要标签页：**LFP 信号仪表盘** 和 **Spike 信号仪表盘**。所有视图都通过一个共享的**时间轴滑块**进行同步控制，用户可以通过拖动滑块或调整**时间窗口宽度**来动态探索数据的不同时间范围。

### 2.1. LFP 信号仪表盘

此页面专注于展示局部场电位 (LFP) 数据。

#### **左侧：标准视图 (Standard View: LFP Heatmap)**

-   **作用**: LFP 数据的传统时空热图展示。
-   **如何解读**:
    -   **X轴**: 时间 (秒)。
    -   **Y轴**: 探针的物理深度。图表左侧的坐标轴和右侧的脑区标签（如 CA1, DG）标明了不同深度对应的解剖学位置。
    -   **颜色**: 代表原始 LFP 信号的电压值。根据 `coolwarm` 配色方案，**红色**代表正电压，**蓝色**代表负电压，**白色**代表零电压。

#### **右侧：事件相机式视图 (Event-Camera-like View: LFP Power)**

-   **作用**: 本项目的核心创新，它将 LFP 信号转换为特定频段的**能量强度**，从而将连续信号转化为“事件”。
-   **如何解读**:
    -   **空间排布**: 该视图是一个一维的热图。**Y轴**代表探针的物理深度，与左侧视图完全对应。每一个“像素”在垂直方向上的位置，都精确地反映了其对应的**电极通道在探针上的物理位置**。这使得我们可以直观地观察到神经活动是如何沿着探针的深度进行传播的。
    -   **颜色**: 代表特定频段的能量。根据 `magma` 配色方案，**亮黄色/白色**代表能量最强，**暗紫色/黑色**代表能量较弱。
    -   **时空模式**: 通过观察**亮黄色区域**的动态变化，您可以发现传统视图中不明显的模式，如行波（traveling waves）和节律性爆发。
-   **可配置参数**:
    -   **脑波频段 (Frequency Band)**: 用户可以选择不同的脑波频段进行分析，如 **Gamma (30-80Hz)**、**Theta (4-12Hz)** 或 **Alpha (8-13Hz)** 等。更改此选项会实时重新计算并展示对应频段的能量视图。
    -   **时间窗口宽度 (Time Window)**: 通过调整主滑块下方的窗口宽度控件，可以改变分析的时间尺度。**较宽的窗口**有助于观察慢变的整体活动趋势，而**较窄的窗口**则能聚焦于快速、瞬时的神经事件。

---

### 2.2. Spike 信号仪表盘

此页面专注于展示单个神经元的脉冲放电活动。

#### **左侧：标准视图 (Standard View: Spike Raster)**

-   **作用**: 神经脉冲数据的经典光栅图。
-   **如何解读**:
    -   **X轴**: 时间 (秒)。
    -   **Y轴**: 单个神经元的 ID，已按其物理深度排序。
    -   **标记**: 图中的每一个**垂直短线**都代表一个神经元在特定时间点的一次脉冲放电。
    -   **颜色**: 短线的颜色代表该神经元所属的脑区，有助于快速区分不同脑区的放电模式。

#### **右侧：事件相机式视图 (Spike Event Panels)**

-   **作用**: 将离散的脉冲事件转化为一幅动态的、有组织的“星空图”，直观展示时空活动模式。
-   **如何解读**:
    -   **面板 (Panels)**: 画面被分割为多个垂直面板，每个面板代表一个独立的脑区（如 CA1, DG）。
    -   **空间排布**: 在每个脑区面板内部，每一个闪烁的方块都代表一个单独的神经元。这些方块的**二维空间位置 (X, Y)** 精确地对应了该**神经元所在电极在探针上的物理坐标**。这种布局保留了神经元在解剖结构上的相对位置关系。
    -   **闪烁的方块**: 当神经元放电时，其对应的方块会瞬间**点亮至最亮**，然后亮度在接下来的几帧中**逐渐衰减**。
    -   **时空模式**: 通过观察方块的闪烁，您可以直观地比较脑区活跃度、发现激活序列和识别同步放电的神经元集群。
-   **可配置参数**:
    -   **衰减因子 (Decay Factor)**: 可以调整方块点亮后亮度衰减的速度。**较高的衰减因子**意味着亮度持续时间更长，有助于观察活动轨迹；**较低的因子**则使事件更“瞬时”，适合观察快速的节律。
    -   **时间窗口宽度 (Time Window)**: 与 LFP 视图共享，同样可以调整关注的时间范围。

---

## 3. 如何使用本项目

### 3.1. 依赖安装

为了运行本项目，您需要一个配置好特定库的 Python 环境。推荐使用 `conda` 或 `virtualenv` 等工具来管理环境。

我们提供了一个 `requirements.txt` 文件，以便您快速安装所有必需的依赖项。

**安装方法:**

1.  **定位文件**: 确保 `requirements.txt` 文件位于您的当前工作目录中，或者提供其完整路径。
2.  **运行安装命令**: 在您的终端或命令行中，执行以下命令：

    ```bash
    pip install -r requirements.txt
    ```

此命令会自动下载并安装文件中列出的所有库及其指定的版本。

如果您希望手动安装，以下是核心库的列表：

```
# 核心依赖库列表
allensdk==2.13.5
numpy==1.21.5
scipy==1.7.3
PyQt5==5.15.6
pyqtgraph==0.12.4
pandas==1.3.5
tqdm==4.62.3
opencv-python==4.5.5.64
```


### 3.2. 数据预处理

在运行主程序之前，必须先将原始的 NWB 数据文件处理成仪表盘专用的高效帧格式。此步骤是确保仪表盘能够流畅交互的关键。

**首次运行:**
首次运行预处理脚本时，`AllenSDK` 会自动从艾伦研究所的服务器下载所需的大量原始数据。这些数据将被存储在项目根目录下的 `ecephys_cache` 文件夹中。请确保您有稳定的网络连接和足够的磁盘空间（可能需要数 GB）。此过程只需进行一次。

**预处理逻辑**:
数据预处理脚本会访问 `ecephys_cache` 目录中的 NWB 缓存文件。
-   对于 **LFP 数据**，脚本会加载指定探针的 LFP 时间序列，对其进行带通滤波（例如，提取 Gamma 频段），然后计算其能量（通过希尔伯特变换），最后根据设定的帧率和积分窗口，将连续的能量信号切割、平均（或取最大值），生成一系列二维的“能量帧”。
-   对于 **Spike 数据**，脚本会加载所有神经元的放电时间戳和它们的物理位置。然后，它会根据脑区划分创建不同的面板布局。最后，它会模拟一个随时间演变的“亮度矩阵”，每当有神经元放电时，就在其对应位置上将亮度设置为最大值，并在后续帧中使其按指数衰减。

请在激活的 Python 环境下，在项目根目录 (`Neuro_Pulse_Canvas`) 中依次运行以下两个脚本：

```bash
# 1. 预处理 LFP 数据
python precompute_lfp_frames.py

# 2. 预处理 Spike 数据
python precompute_spike_frames.py
```

成功运行后，项目根目录下会生成 `lfp_frames_gamma.npz` 和 `spike_frames.npz` 数据文件。这些文件已被 `.gitignore` 排除，不会上传到版本库。

### 3.3. 运行仪表盘

完成以上步骤后，运行主应用程序脚本：

```bash
python dashboard_app.py
```

程序启动后，会首先加载所有预处理好的数据（可能需要一些时间），然后显示交互式仪表盘窗口。
